<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GunJS Counter with WebRTC</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>
</head>
<body>
    <h1>Counter</h1>
    <div id="counter">0</div>
    <button id="increment">+</button>
    <button id="decrement">-</button>

    <script>
        // Подключение Gun с WebRTC и STUN-серверами
        const gun = Gun({
            peers: [], // P2P без центрального сервера
            rtc: {
                iceServers: [
                    { urls: "stun:stun.l.google.com:19302" },
                    { urls: "stun:stun1.l.google.com:19302" }
                ]
            },
            radisk: true
        });

        // Создаем узел для хранения значения счетчика
        const counter = gun.get('counter');

        // DOM элементы
        const counterDisplay = document.getElementById('counter');
        const incrementBtn = document.getElementById('increment');
        const decrementBtn = document.getElementById('decrement');

        // Гарантируем начальную синхронизацию
        gun.on('hi', peer => {
            console.log('Connected to new peer:', peer);
            // Запрашиваем данные у нового пира
            counter.once(data => {
                if (!data || data.value === undefined) {
                    // Если данных нет, отправляем текущее состояние
                    console.log('Sending initial counter state');
                    counter.put({ value: parseInt(counterDisplay.textContent) });
                } else {
                    // Если данные есть, синхронизируем их
                    console.log('Receiving counter state from peer:', data);
                    counterDisplay.textContent = data.value;
                }
            });
        });

        // Синхронизация данных
        counter.on(data => {
            if (data && typeof data.value === 'number') {
                counterDisplay.textContent = data.value; // Отображаем значение счетчика
            }
        });

        // Обработчики кнопок
        incrementBtn.addEventListener('click', () => {
            counter.once(data => {
                const currentValue = (data && data.value) || 0;
                counter.put({ value: currentValue + 1 }); // Увеличиваем счетчик
            });
        });

        decrementBtn.addEventListener('click', () => {
            counter.once(data => {
                const currentValue = (data && data.value) || 0;
                counter.put({ value: currentValue - 1 }); // Уменьшаем счетчик
            });
        });
    </script>
</body>

</html>
