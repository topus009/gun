<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrbitDB Counter</title>
    <script src="https://unpkg.com/ipfs@latest/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/orbit-db/dist/orbitdb.min.js"></script>
</head>
<body>
    <h1>OrbitDB Counter</h1>
    <div id="counter">0</div>
    <button id="increment">+</button>
    <button id="decrement">-</button>
    <p id="status">Connecting...</p>

    <script>
        (async () => {
            const statusEl = document.getElementById('status');
            const counterEl = document.getElementById('counter');
            const incrementBtn = document.getElementById('increment');
            const decrementBtn = document.getElementById('decrement');

            try {
                // 1. Создаем экземпляр IPFS
                statusEl.textContent = 'Starting IPFS...';
                const ipfs = await IPFS.create({
                    repo: './ipfs-repo-' + Math.random(),
                    EXPERIMENTAL: { pubsub: true },
                    config: {
                        Addresses: {
                            Swarm: [
                                '/dns4/ws-star.discovery.libp2p.io/tcp/443/wss/p2p-websocket-star' // WebRTC-трекер
                            ]
                        }
                    }
                });

                statusEl.textContent = 'IPFS started. Initializing OrbitDB...';

                // 2. Создаем OrbitDB
                const orbitdb = await OrbitDB.createInstance(ipfs);

                // 3. Подключаемся к базе данных
                const db = await orbitdb.keyvalue('counter-db', {
                    accessController: {
                        write: ['*'] // Разрешаем запись всем
                    }
                });
                await db.load(); // Загружаем данные

                statusEl.textContent = 'Connected to database. Syncing...';

                // 4. Отображаем текущее значение счетчика
                const updateCounter = () => {
                    const value = db.get('value') || 0; // Если нет данных, берем 0
                    counterEl.textContent = value;
                };
                updateCounter();

                // Подписываемся на изменения
                db.events.on('replicated', () => {
                    console.log('Database replicated');
                    updateCounter();
                });

                db.events.on('write', () => {
                    console.log('Database write event');
                    updateCounter();
                });

                // 5. Обработчики кнопок
                incrementBtn.addEventListener('click', async () => {
                    const currentValue = db.get('value') || 0;
                    await db.put('value', currentValue + 1); // Увеличиваем счетчик
                });

                decrementBtn.addEventListener('click', async () => {
                    const currentValue = db.get('value') || 0;
                    await db.put('value', currentValue - 1); // Уменьшаем счетчик
                });

                statusEl.textContent = 'Ready!';
            } catch (error) {
                console.error('Error initializing OrbitDB:', error);
                statusEl.textContent = 'Error initializing OrbitDB.';
            }
        })();
    </script>
</body>
</html>
